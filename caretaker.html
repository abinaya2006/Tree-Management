<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Caretaker Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    a { text-decoration: none; color: inherit; }

    /* Top nav */
    .navbar {
      height: 56px;
      background: #2c5f2d;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .navbar-title {
      font-weight: 600;
      font-size: 18px;
    }
    .navbar-subtitle {
      font-size: 13px;
      opacity: 0.9;
    }
    .navbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 13px;
    }
    .status-pill {
      padding: 4px 10px;
      border-radius: 50px;
      font-size: 11px;
      background: #1b5e20;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #fff;
      color: #2c5f2d;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }
    .notification-badge {
      position: relative;
    }
    .badge-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ff5252;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    /* Layout */
    .page {
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .page-header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .page-header h1 {
      font-size: 24px;
      font-weight: 600;
    }
    .page-header-subtext {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .btn {
      border: none;
      border-radius: 4px;
      font-size: 13px;
      padding: 8px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.05s;
    }
    .btn-primary {
      background: #2c5f2d;
      color: #fff;
    }
    .btn-primary:hover { background: #1e4620; }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-secondary:hover { background: #d0d0d0; }
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    .btn-warning:hover { background: #e68900; }
    .btn:active { transform: scale(0.98); }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Stats row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    @media (max-width: 900px) {
      .stats-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 600px) {
      .stats-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .stat-card {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #eee;
    }
    .stat-label {
      font-size: 11px;
      color: #777;
      margin-bottom: 6px;
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #2c5f2d;
    }
    .stat-card.alert {
      border-left: 4px solid #ff9800;
      background: #fff8f0;
    }
    .stat-card.alert .stat-value {
      color: #ff9800;
    }

    /* Main grid - 2 column */
    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }
    @media (max-width: 1000px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
    }
    .card-subtitle {
      font-size: 12px;
      color: #777;
      margin-top: 2px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 12px;
    }
    .tab-btn {
      padding: 8px 12px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 13px;
      color: #777;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn.active {
      color: #2c5f2d;
      border-bottom-color: #2c5f2d;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Trees grid */
    .trees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .tree-card {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      transition: all 0.2s;
      cursor: pointer;
    }
    .tree-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-color: #2c5f2d;
    }
    .tree-card.urgent {
      background: #fff8f0;
      border-color: #ff9800;
    }
    .tree-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .tree-card-name {
      font-weight: 600;
      font-size: 13px;
      flex: 1;
    }
    .health-emoji {
      font-size: 20px;
      margin-left: 6px;
    }
    .tree-card-meta {
      font-size: 12px;
      color: #666;
    }
    .tree-card-buttons {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .tree-card-buttons button {
      flex: 1;
      padding: 4px 6px;
      font-size: 11px;
    }

    /* Observations list */
    .observations-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    .observation-item {
      padding: 12px;
      border-left: 3px solid #2c5f2d;
      background: #f9f9f9;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .observation-item.critical {
      border-left-color: #ff5252;
      background: #fff5f5;
    }
    .observation-item.high {
      border-left-color: #ff9800;
      background: #fff8f0;
    }
    .observation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .observation-title {
      font-weight: 600;
      font-size: 13px;
    }
    .severity-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .severity-badge.critical {
      background: #ff5252;
      color: white;
    }
    .severity-badge.high {
      background: #ff9800;
      color: white;
    }
    .severity-badge.medium {
      background: #2196f3;
      color: white;
    }
    .severity-badge.low {
      background: #4caf50;
      color: white;
    }
    .observation-meta {
      font-size: 11px;
      color: #777;
      margin-bottom: 6px;
    }
    .observation-details {
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .observation-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .observation-buttons button {
      flex: 1;
      min-width: 80px;
      padding: 4px 8px;
      font-size: 11px;
    }

    /* Filters */
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    .filters-row input,
    .filters-row select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 12px;
      min-width: 120px;
    }

    /* Zone info */
    .zone-info {
      background: #f0f8f1;
      border-left: 4px solid #2c5f2d;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    .zone-info-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    .zone-info-label {
      color: #666;
    }
    .zone-info-value {
      font-weight: 600;
      color: #2c5f2d;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      /* overflow-y: auto; */
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .modal-header {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }
    .form-group {
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2c5f2d;
      box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .modal-footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 24px;
      color: #777;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e0e0e0;
      border-top-color: #2c5f2d;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 24px;
      color: #999;
      font-size: 13px;
    }
  </style>
</head>
<body>

<!-- Top navbar -->
<nav class="navbar">
  <div class="navbar-left">
    <div>
      <div class="navbar-title">üå≥ Tree Inventory</div>
      <div class="navbar-subtitle" id="caretakerZoneLabel">Loading‚Ä¶</div>
    </div>
  </div>
  <div class="navbar-right">
    <div id="todayLabel">Today</div>
    <div class="notification-badge" onclick="openNotificationsModal()">
      üîî
      <span class="badge-count" id="notificationCount" style="display:none;">0</span>
    </div>
    <div class="status-pill">
      <span class="status-dot"></span>
      <span>Online</span>
    </div>
    <div class="avatar" id="caretakerAvatar">CT</div>
    <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px;" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="page">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>My Zone Dashboard</h1>
      <div class="page-header-subtext">View, manage trees, and respond to observations in your zone.</div>
    </div>
    <div class="quick-actions">
      <button class="btn btn-secondary" onclick="openQRModal()">üì± Scan QR</button>
      <button class="btn btn-secondary" onclick="viewMyHistory()">üìä My History</button>
    </div>
  </div>

  <!-- Zone info -->
  <div class="zone-info">
    <div class="zone-info-row">
      <span class="zone-info-label">Zone:</span>
      <span class="zone-info-value" id="zoneDisplayName">Loading‚Ä¶</span>
    </div>
    <div class="zone-info-row">
      <span class="zone-info-label">Total trees assigned:</span>
      <span class="zone-info-value" id="zoneTotalTrees">0</span>
    </div>
    <div class="zone-info-row">
      <span class="zone-info-label">Trees needing care:</span>
      <span class="zone-info-value" id="zoneNeedsCare">0</span>
    </div>
  </div>

  <!-- Stats row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">üü¢ Healthy</div>
      <div class="stat-value" id="statHealthy">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üü° Fair</div>
      <div class="stat-value" id="statFair">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üî¥ Poor</div>
      <div class="stat-value" id="statPoor">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">‚ö´ Dying</div>
      <div class="stat-value" id="statDying">0</div>
    </div>
    <div class="stat-card alert">
      <div class="stat-label">‚ö†Ô∏è Pending Obs.</div>
      <div class="stat-value" id="statPendingObs">0</div>
    </div>
  </div>

  <!-- Main grid -->
  <div class="grid">
    <!-- Left: Trees & Observations -->
    <div>
      <!-- Tabs -->
      <div class="card">
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('trees')">üå≤ My Trees</button>
          <button class="tab-btn" onclick="switchTab('observations')">üìã Observations</button>
        </div>

        <!-- Trees Tab -->
        <div id="trees-tab" class="tab-content active">
          <div class="filters-row">
            <input type="text" id="filterSearch" placeholder="Search tree name..." onkeyup="renderTrees()">
            <select id="filterHealth" onchange="renderTrees()">
              <option value="">All health status</option>
              <option value="healthy">üü¢ Healthy</option>
              <option value="fair">üü° Fair</option>
              <option value="poor">üî¥ Poor</option>
              <option value="dying">‚ö´ Dying</option>
            </select>
          </div>
          <div class="trees-grid" id="treesGrid">
            <div class="loading"><div class="spinner"></div> Loading trees...</div>
          </div>
          <div id="noTreesMessage" class="empty-state" style="display:none;">
            No trees match your filters.
          </div>
        </div>

        <!-- Observations Tab -->
        <div id="observations-tab" class="tab-content">
          <div class="filters-row">
            <select id="filterObsSeverity" onchange="renderObservations()">
              <option value="">All severity levels</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select id="filterObsStatus" onchange="renderObservations()">
              <option value="">All status</option>
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>
          <div class="observations-list" id="observationsList">
            <div class="loading"><div class="spinner"></div> Loading observations...</div>
          </div>
          <div id="noObsMessage" class="empty-state" style="display:none;">
            No observations for your zone.
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Notifications & Quick Actions -->
    <div>
      <!-- Notifications Card -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">üîî Recent Notifications</div>
            <div class="card-subtitle">Last 5 notifications</div>
          </div>
        </div>
        <div id="notificationsList" class="observations-list" style="margin-top:0;">
          <div class="empty-state">No notifications yet</div>
        </div>
      </div>

     

<!-- Health Update Modal -->
<div class="modal" id="healthModal">
  <div class="modal-content">
    <div class="modal-header">
      <div>Update Tree Health</div>
      <button class="modal-close" onclick="closeHealthModal()">√ó</button>
    </div>
    <form id="healthForm" onsubmit="saveTreeHealth(event)">
      <div class="form-group">
        <label>Tree:</label>
        <input type="text" id="modalTreeName" readonly style="background:#f5f5f5;">
      </div>
      <div class="form-group">
        <label>Current Health:</label>
        <input type="text" id="modalCurrentHealth" readonly style="background:#f5f5f5;">
      </div>
      <div class="form-group">
        <label>New Health Status:</label>
        <select id="modalNewHealth" required>
          <option value="">Select status</option>
          <option value="healthy">üü¢ Healthy</option>
          <option value="fair">üü° Fair</option>
          <option value="poor">üî¥ Poor</option>
          <option value="dying">‚ö´ Dying</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes (optional):</label>
        <textarea id="modalNotes" placeholder="Describe observations, treatment applied, etc."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeHealthModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Update</button>
      </div>
    </form>
  </div>
</div>

<!-- Observation Response Modal -->
<div class="modal" id="obsResponseModal">
  <div class="modal-content">
    <div class="modal-header">
      <div>Respond to Observation</div>
      <button class="modal-close" onclick="closeObsResponseModal()">√ó</button>
    </div>
    <div id="obsResponseContent">
      <!-- Filled by JS -->
    </div>
    <form id="obsResponseForm" onsubmit="submitObsResponse(event)">
        <div class="form-group">
        <label>New Health Status:</label>
        <select id="modalNewHealthObs" required>
          <option value="">Select status</option>
          <option value="healthy">üü¢ Healthy</option>
          <option value="fair">üü° Fair</option>
          <option value="poor">üî¥ Poor</option>
          <option value="dying">‚ö´ Dying</option>
        </select>
      </div>

      <div class="form-group">
        <label>Status:</label>
        <select id="respStatus" required>
          <option value="">Select status</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="resolved">Resolved</option>
        </select>
      </div>
      <div class="form-group">
        <label>Your Response:</label>
        <textarea id="respNotes" required placeholder="What actions have you taken? What's the outcome?"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeObsResponseModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Submit Response</button>
      </div>
    </form>
  </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal" id="qrModal">
  <div class="modal-content">
    <div class="modal-header">
      <div>Scan Tree QR Code</div>
      <button class="modal-close" onclick="closeQRModal()">√ó</button>
    </div>
    <div class="form-group">
      <label>Scan QR code or enter Tree ID:</label>
      <input type="text" id="qrInput" placeholder="Tree ID or scan..." autofocus>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeQRModal()">Cancel</button>
      <button type="button" class="btn btn-primary" onclick="handleQRInput()">Find Tree</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCNV72D3X6ecI3tpqnPt4CUWJzrLo83Bkc",
    authDomain: "try-firebase-bdb77.firebaseapp.com",
    projectId: "try-firebase-bdb77",
    storageBucket: "try-firebase-bdb77.appspot.com",
    messagingSenderId: "327656427702",
    appId: "1:327656427702:web:c2bf0fff68d18460029617"
  };
  
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  
  const auth = firebase.auth();
  const db = firebase.firestore();

  // State
  let currentUser = null;
  let userDoc = null;
  let caretakerZoneId = null;
  let userCollege = null;
  let allTrees = [];
  let allObservations = [];
  let allNotifications = [];
  let currentEditingTreeId = null;
  let currentRespondingObsId = null;
  let zoneMap = {};


  // Helpers
  // Replace the formatDate function with this:
function formatDate(date) {
  if (!date) return "-";
  
  // If it's a Firestore timestamp
  if (date.toDate && typeof date.toDate === 'function') {
    date = date.toDate();
  }
  
  // If it's already a Date object
  if (date instanceof Date && !isNaN(date)) {
    return date.toLocaleDateString(undefined, { day: "2-digit", month: "short" });
  }
  
  // If it's a string, try to parse it
  if (typeof date === "string") {
    const parsedDate = new Date(date);
    if (!isNaN(parsedDate)) {
      return parsedDate.toLocaleDateString(undefined, { day: "2-digit", month: "short" });
    }
  }
  
  // If it's a number (timestamp)
  if (typeof date === "number") {
    const parsedDate = new Date(date);
    if (!isNaN(parsedDate)) {
      return parsedDate.toLocaleDateString(undefined, { day: "2-digit", month: "short" });
    }
  }
  
  return "-";
}1

  function setTodayLabel() {
  const now = new Date();
  if (now instanceof Date && !isNaN(now)) {
    document.getElementById("todayLabel").textContent = now.toLocaleDateString(undefined, {
      weekday: "short",
      day: "2-digit",
      month: "short",
    });
  } else {
    document.getElementById("todayLabel").textContent = "Today";
  }
}
  function healthEmoji(health) {
    const emojis = { healthy: "üü¢", fair: "üü°", poor: "üî¥", dying: "‚ö´" };
    return emojis[health] || "‚ö™";
  }

  // Tab switching - FIXED: Added event parameter
  function switchTab(tabName, event) {
    event.preventDefault();
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');

    if (tabName === 'observations') {
      renderObservations();
    } else {
      renderTrees();
    }
  }

  // Load zone trees
  async function loadZoneTrees() {
    if (!caretakerZoneId) {
      allTrees = [];
      renderTrees();
      return;
    }

    try {
      const snap = await db
        .collection("trees")
        .where("zoneId", "==", caretakerZoneId)
        .get();
      
      allTrees = [];
      snap.forEach((doc) => {
        const data = doc.data();
        allTrees.push({ 
          id: doc.id, 
          ...data,
          zoneId: data.zoneId || caretakerZoneId
        });
      });

      renderTrees();
      updateStatsAndKPIs();
    } catch (err) {
      console.error(err);
      document.getElementById("treesGrid").innerHTML = `<div class="loading" style="color:red;">Error loading trees: ${err.message}</div>`;
    }
  }

  // Render trees
  function renderTrees() {
    const grid = document.getElementById("treesGrid");
    const searchVal = document.getElementById("filterSearch").value.toLowerCase();
    const healthFilter = document.getElementById("filterHealth").value;

    let filtered = allTrees.filter(t => {
      const matchesSearch = !searchVal || 
        (t.commonName && t.commonName.toLowerCase().includes(searchVal));
      const matchesHealth = !healthFilter || t.healthStatus === healthFilter;
      return matchesSearch && matchesHealth;
    });

    if (filtered.length === 0) {
      grid.innerHTML = "";
      document.getElementById("noTreesMessage").style.display = "block";
      return;
    }

    document.getElementById("noTreesMessage").style.display = "none";
    grid.innerHTML = filtered.map(tree => {
      // FIXED: Properly escape special characters in template literals
      const treeName = tree.commonName || "Unknown";
      const species = tree.species || "Species unknown";
      const healthStatus = tree.healthStatus || "unknown";
      const lastCheckedAt = tree.lastCheckedAt ? 
        (tree.lastCheckedAt.toDate ? tree.lastCheckedAt.toDate() : new Date(tree.lastCheckedAt)) : 
        null;
      
      return `
      <div class="tree-card ${healthStatus === 'dying' || healthStatus === 'poor' ? 'urgent' : ''}">
        <div class="tree-card-header">
          <div class="tree-card-name">${treeName}</div>
          <div class="health-emoji">${healthEmoji(healthStatus)}</div>
        </div>
        <div class="tree-card-meta">
          <div>${species}</div>
          <div style="margin-top:4px;color:#999;">Last checked: ${formatDate(lastCheckedAt)}</div>
        </div>
        <div class="tree-card-buttons">
          <button class="btn btn-primary" onclick="openHealthModal('${tree.id.replace(/'/g, "\\'")}')">Update</button>
          <button class="btn btn-secondary" onclick="viewTreeDetails('${tree.id.replace(/'/g, "\\'")}')">View</button>
        </div>
      </div>
    `}).join("");
  }

  // Load observations
  async function loadObservations() {
  if (!caretakerZoneId) {
    allObservations = [];
    renderObservations();
    return;
  }

  try {
    const snap = await db.collection("observations")
      .where("treeZone", "==", caretakerZoneId)
      .orderBy("submittedAt", "desc")
      .get();
    
    allObservations = [];
    snap.forEach(doc => {
      const data = doc.data();
      
      // Convert Firestore timestamp to Date object
      let submittedAt = null;
      if (data.submittedAt) {
        if (data.submittedAt.toDate && typeof data.submittedAt.toDate === 'function') {
          submittedAt = data.submittedAt.toDate();
        } else if (data.submittedAt instanceof Date) {
          submittedAt = data.submittedAt;
        } else if (typeof data.submittedAt === 'string') {
          submittedAt = new Date(data.submittedAt);
        } else if (typeof data.submittedAt === 'number') {
          submittedAt = new Date(data.submittedAt);
        }
      }
      
      allObservations.push({ 
        id: doc.id, 
        ...data,
        submittedAt: submittedAt
      });
    });

    renderObservations();
    updateStatsAndKPIs();
  } catch (err) {
    console.error(err);
      // FIXED: Check if error is due to missing index
      if (err.code === 'failed-precondition') {
        console.warn("Firestore index needed for observations query");
        // Try without ordering if index is missing
        try {
          const snap = await db.collection("observations")
            .where("treeZone", "==", caretakerZoneId)
            .get();
          
          allObservations = [];
          snap.forEach(doc => {
            const data = doc.data();
            allObservations.push({ 
              id: doc.id, 
              ...data,
              submittedAt: data.submittedAt ? (data.submittedAt.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt)) : null
            });
          });
          
          // Sort manually
          allObservations.sort((a, b) => {
            const dateA = a.submittedAt || new Date(0);
            const dateB = b.submittedAt || new Date(0);
            return dateB - dateA;
          });
          
          renderObservations();
          updateStatsAndKPIs();
        } catch (innerErr) {
          console.error("Error loading observations:", innerErr);
        }
      }
    }
  }

  // Render observations
  function renderObservations() {
    const container = document.getElementById("observationsList");
    const severityFilter = document.getElementById("filterObsSeverity").value;
    const statusFilter = document.getElementById("filterObsStatus").value;

    let filtered = allObservations.filter(obs => {
      const matchesSeverity = !severityFilter || obs.severity === severityFilter;
      const matchesStatus = !statusFilter || obs.status === statusFilter;
      return matchesSeverity && matchesStatus;
    });

    if (filtered.length === 0) {
      container.innerHTML = "";
      document.getElementById("noObsMessage").style.display = "block";
      return;
    }

    document.getElementById("noObsMessage").style.display = "none";
    container.innerHTML = filtered.map(obs => {
      // FIXED: Properly escape special characters
      const treeName = obs.treeName || "Unknown Tree";
      const observerName = obs.observerName || "Unknown";
      const details = obs.details || "No details provided";
      
      return `
      <div class="observation-item ${obs.severity === 'critical' || obs.severity === 'high' ? obs.severity : ''}">
        <div class="observation-header">
          <div class="observation-title">${treeName}</div>
          <span class="severity-badge ${obs.severity || 'low'}">${(obs.severity || 'low').toUpperCase()}</span>
        </div>
        <div class="observation-meta">
          <strong>${obs.observationType || 'Observation'}</strong> ‚Ä¢ ${formatDate(obs.submittedAt)} ‚Ä¢ By: ${observerName}
        </div>
        <div class="observation-details">${details}</div>
        <div style="font-size:11px;color:#777;">Status: <strong>${obs.status || 'pending'}</strong></div>
        <div class="observation-buttons">
          <button class="btn btn-primary" onclick="openObsResponseModal('${obs.id.replace(/'/g, "\\'")}')">Respond</button>
          <button class="btn btn-secondary" onclick="viewObsDetails('${obs.id.replace(/'/g, "\\'")}')">Details</button>
        </div>
      </div>
    `}).join("");
  }

  // Load notifications
  async function loadNotifications() {
    if (!currentUser) return;

    try {
        // OPTION 1: Get notifications where userId matches current user
        const snap = await db.collection("notifications")
            .where("userId", "==", currentUser.uid)
            .orderBy("createdAt", "desc")
            .limit(5)
            .get();
        
        allNotifications = [];
        snap.forEach(doc => {
            const data = doc.data();
            allNotifications.push({ 
                id: doc.id, 
                ...data,
                createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date()
            });
        });

        renderNotifications();
        updateNotificationBadge();
    } catch (err) {
        console.error("Error loading notifications:", err);
        
        // Fallback without ordering
        try {
            const snap = await db.collection("notifications")
                .where("userId", "==", currentUser.uid)
                .limit(5)
                .get();
            
            allNotifications = [];
            snap.forEach(doc => {
                const data = doc.data();
                allNotifications.push({ 
                    id: doc.id, 
                    ...data,
                    createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date()
                });
            });
            
            // Sort manually
            allNotifications.sort((a, b) => b.createdAt - a.createdAt);
            
            renderNotifications();
            updateNotificationBadge();
        } catch (innerErr) {
            console.error("Fallback also failed:", innerErr);
            allNotifications = [];
            renderNotifications();
            updateNotificationBadge();
        }
    }
}

  // Render notifications
  async function loadNotifications() {
    if (!currentUser) {
        console.error("No current user");
        return;
    }

    const currentUserId = currentUser.uid;
    console.log("Loading notifications for:", currentUserId);

    try {
        // Get all notifications (we'll filter client-side)
        const snap = await db.collection("notifications")
            .orderBy("createdAt", "desc")
            .limit(50)
            .get();
        
        console.log("Total notifications found:", snap.size);
        
        allNotifications = [];
        snap.forEach(doc => {
            const data = doc.data();
            console.log("Checking notification:", doc.id, "data:", data);
            
            // Check if this notification belongs to current user using various field names
            const isForCurrentUser = 
                data.userId === currentUserId ||
                data.caretakerId === currentUserId ||
                data.assignedTo === currentUserId ||
                data.toUserId === currentUserId;
            
            // Also check if it's a zone notification for this caretaker's zone
            const isZoneNotification = data.zoneId === caretakerZoneId;
            
            if (isForCurrentUser || isZoneNotification) {
                allNotifications.push({ 
                    id: doc.id, 
                    ...data,
                    createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date()
                });
            }
        });
        
        console.log("Filtered notifications for user:", allNotifications.length);
        renderNotifications();
        updateNotificationBadge();
        
    } catch (err) {
        console.error("Error loading notifications:", err);
        allNotifications = [];
        renderNotifications();
        updateNotificationBadge();
    }
}

function renderNotifications() {
    const container = document.getElementById("notificationsList");
    
    console.log("Rendering", allNotifications.length, "notifications");
    
    if (allNotifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div>üîî No new notifications</div>
                <div style="font-size:11px;color:#999;margin-top:5px;">
                    User ID: ${currentUser?.uid?.substring(0, 10) || 'none'}
                </div>
            </div>
        `;
        return;
    }

    container.innerHTML = allNotifications.map(notif => {
        const title = notif.title || "Notification";
        const message = notif.message || "No message";
        const isUnread = !notif.read;
        const dateStr = formatDate(notif.createdAt); // Use formatDate function
        
        return `
        <div class="observation-item ${isUnread ? 'high' : ''}">
            <div class="observation-header">
                <div class="observation-title">${title}</div>
                ${isUnread ? '<span style="font-size:10px;color:#ff9800;">NEW</span>' : ''}
            </div>
            <div class="observation-meta">${dateStr}</div>
            <div class="observation-details">${message}</div>
            <div class="observation-buttons">
                <button class="btn btn-secondary" onclick="markNotificationRead('${notif.id.replace(/'/g, "\\'")}')">
                    ${isUnread ? 'Mark read' : 'Read'}
                </button>
                
            </div>
        </div>
        `;
        // <button class="btn btn-primary" onclick="viewNotificationDetails('${notif.id.replace(/'/g, "\\'")}')">
        //             View
        //         </button>
    }).join("");
}
  // Update notification badge
  function updateNotificationBadge() {
    const unreadCount = allNotifications.filter(n => !n.read).length;
    const badge = document.getElementById("notificationCount");
    if (unreadCount > 0) {
      badge.textContent = unreadCount;
      badge.style.display = "flex";
    } else {
      badge.style.display = "none";
    }
  }

  // Mark notification as read
  async function markNotificationRead(notifId) {
    try {
      await db.collection("notifications").doc(notifId).update({
        read: true
      });
      await loadNotifications();
    } catch (err) {
      console.error(err);
    }
  }

  // Update stats
  function updateStatsAndKPIs() {
    const stats = { healthy: 0, fair: 0, poor: 0, dying: 0 };
    allTrees.forEach(t => {
      const status = t.healthStatus || "unknown";
      if (stats.hasOwnProperty(status)) stats[status]++;
    });

    document.getElementById("statHealthy").textContent = stats.healthy;
    document.getElementById("statFair").textContent = stats.fair;
    document.getElementById("statPoor").textContent = stats.poor;
    document.getElementById("statDying").textContent = stats.dying;

    document.getElementById("zoneTotalTrees").textContent = allTrees.length;
    document.getElementById("zoneNeedsCare").textContent = stats.poor + stats.dying;

    const pendingObs = allObservations.filter(o => !o.status || o.status !== 'resolved').length;
    document.getElementById("statPendingObs").textContent = pendingObs;
  }

  // Health modal
  async function openHealthModal(treeId) {
    const tree = allTrees.find(t => t.id === treeId);
    if (!tree) return;

    currentEditingTreeId = treeId;
    document.getElementById("modalTreeName").value = tree.commonName || "Unknown";
    document.getElementById("modalCurrentHealth").value = tree.healthStatus || "unknown";
    document.getElementById("modalNewHealth").value = "";
    document.getElementById("modalNotes").value = tree.notes || "";
    document.getElementById("healthModal").classList.add("active");
  }

  function closeHealthModal() {
    document.getElementById("healthModal").classList.remove("active");
    currentEditingTreeId = null;
  }

  async function saveTreeHealth(e) {
    e.preventDefault();
    if (!currentEditingTreeId) return;

    const newHealth = document.getElementById("modalNewHealth").value;
    const notes = document.getElementById("modalNotes").value;

    if (!newHealth) {
      alert("Please select a health status");
      return;
    }

    try {
      await db.collection("trees").doc(currentEditingTreeId).update({
        healthStatus: newHealth,
        lastCheckedBy: currentUser.uid,
        lastCheckedAt: firebase.firestore.FieldValue.serverTimestamp(),
        notes: notes,
      });

      // Log update
      await db.collection("tree_logs").add({
        treeId: currentEditingTreeId,
        caretakerId: currentUser.uid,
        oldStatus: document.getElementById("modalCurrentHealth").value,
        newStatus: newHealth,
        notes: notes,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      alert("‚úì Tree health updated!");
      closeHealthModal();
      await loadZoneTrees();
    } catch (err) {
      console.error(err);
      alert("Error: " + err.message);
    }
  }

  // Observation response
  async function openObsResponseModal(obsId) {
  const obs = allObservations.find(o => o.id === obsId);
  if (!obs) return;

  currentRespondingObsId = obsId;
  currentEditingTreeId = obs.treeId; // Set the tree ID for this observation
  
  document.getElementById("obsResponseContent").innerHTML = `
    <div style="font-size:13px;margin-bottom:12px;">
      <strong>Tree:</strong> ${obs.treeName || "Unknown"}<br>
      <strong>Type:</strong> ${obs.observationType || "General"}<br>
      <strong>Severity:</strong> ${obs.severity || "low"}<br>
      <strong>Submitted by:</strong> ${obs.observerName || "Unknown"}<br>
      <strong>Details:</strong> ${obs.details || "No details"}
    </div>
  `;
  
  // Set current health status in the form
  if (currentEditingTreeId) {
    const tree = allTrees.find(t => t.id === currentEditingTreeId);
    if (tree) {
      document.getElementById("modalCurrentHealth").value = tree.healthStatus || "unknown";
    }
  }
  
  document.getElementById("obsResponseModal").classList.add("active");
}

  function closeObsResponseModal() {
    document.getElementById("obsResponseModal").classList.remove("active");
    currentRespondingObsId = null;
  }

  async function submitObsResponse(e) {
  e.preventDefault();
  if (!currentRespondingObsId) return;

  // Get the observation first
  const obs = allObservations.find(o => o.id === currentRespondingObsId);
  if (!obs) {
    alert("Observation not found");
    return;
  }

  // Get the tree for this observation
  const treeId = obs.treeId;
  if (!treeId) {
    alert("Tree ID not found in observation");
    return;
  }

  const newHealth = document.getElementById("modalNewHealthObs").value;
  const status = document.getElementById("respStatus").value;
  const notes = document.getElementById("respNotes").value;

  if (!status || !notes || !newHealth) {
    alert("Please fill all fields");
    return;
  }

  try {
    // First, get the current tree health before updating
    const treeDoc = await db.collection("trees").doc(treeId).get();
    const currentTreeHealth = treeDoc.exists ? (treeDoc.data().healthStatus || "unknown") : "unknown";

    // Update tree health
    await db.collection("trees").doc(treeId).update({
      healthStatus: newHealth,
      lastCheckedBy: currentUser.uid,
      lastCheckedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });

    // Update observation with response
    await db.collection("observations").doc(currentRespondingObsId).update({
      status: status,
      assignedTo: currentUser.uid,
      response: notes,
      respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });

    // Log the update
    await db.collection("tree_logs").add({
      treeId: treeId,
      caretakerId: currentUser.uid,
      oldStatus: currentTreeHealth,
      newStatus: newHealth,
      notes: notes,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

    alert("‚úì Response submitted!");
    closeObsResponseModal();
    await loadObservations();
    await loadZoneTrees(); // Reload trees to update health stats
  } catch (err) {
    console.error(err);
    alert("Error: " + err.message);
  }
}
  // QR Modal
  function openQRModal() {
    document.getElementById("qrModal").classList.add("active");
    document.getElementById("qrInput").value = "";
    setTimeout(() => document.getElementById("qrInput").focus(), 100);
  }

  function closeQRModal() {
    document.getElementById("qrModal").classList.remove("active");
  }

  async function handleQRInput() {
    const qrValue = document.getElementById("qrInput").value.trim();
    if (!qrValue) {
      alert("Please enter a Tree ID");
      return;
    }

    const tree = allTrees.find(t => t.id === qrValue || t.commonName === qrValue);
    if (!tree) {
      alert("Tree not found: " + qrValue);
      return;
    }

    closeQRModal();
    await openHealthModal(tree.id);
  }

  // View tree details
  function viewTreeDetails(treeId) {
    const tree = allTrees.find(t => t.id === treeId);
    if (!tree) return;
    
    // Create a simple modal to show tree details
    const modalHTML = `
      <div class="modal" id="treeDetailModal" style="display:flex;">
        <div class="modal-content">
          <div class="modal-header">
            <div>Tree Details</div>
            <button class="modal-close" onclick="document.getElementById('treeDetailModal').style.display='none'">√ó</button>
          </div>
          <div style="font-size:13px;line-height:1.8;">
            <p><strong>Name:</strong> ${tree.commonName || "Unknown"}</p>
            <p><strong>Health:</strong> ${tree.healthStatus || "unknown"}</p>
            <p><strong>DBH:</strong> ${tree.dbh || "N/A"} cm</p>
            <p><strong>Height:</strong> ${tree.height || "N/A"} m</p>
            <p><strong>Notes:</strong> ${tree.notes || "None"}</p>
            <p><strong>Last checked:</strong> ${formatDate(tree.lastCheckedAt)}</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('treeDetailModal').style.display='none'">Close</button>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('treeDetailModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  // View observation details
  function viewObsDetails(obsId) {
    const obs = allObservations.find(o => o.id === obsId);
    if (!obs) return;
    
    const modalHTML = `
      <div class="modal" id="obsDetailModal" style="display:flex;">
        <div class="modal-content">
          <div class="modal-header">
            <div>Observation Details</div>
            <button class="modal-close" onclick="document.getElementById('obsDetailModal').style.display='none'">√ó</button>
          </div>
          <div style="font-size:13px;line-height:1.8;">
            <p><strong>Tree:</strong> ${obs.treeName || "Unknown"}</p>
            <p><strong>Type:</strong> ${obs.observationType || "General"}</p>
            <p><strong>Severity:</strong> ${obs.severity || "low"}</p>
            <p><strong>Submitted by:</strong> ${obs.observerName || "Unknown"}</p>
            <p><strong>Date:</strong> ${formatDate(obs.submittedAt)}</p>
            <p><strong>Details:</strong> ${obs.details || "No details"}</p>
            <p><strong>Status:</strong> ${obs.status || "pending"}</p>
            ${obs.response ? `<p><strong>Response:</strong> ${obs.response}</p>` : ''}
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('obsDetailModal').style.display='none'">Close</button>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('obsDetailModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  // My history
  function viewMyHistory() {
    if (!currentUser) {
      alert("Please log in first");
      return;
    }
    
    // Create history modal
    const modalHTML = `
      <div class="modal" id="historyModal" style="display:flex;">
        <div class="modal-content" style="max-width:600px;">
          <div class="modal-header">
            <div>My Update History</div>
            <button class="modal-close" onclick="document.getElementById('historyModal').style.display='none'">√ó</button>
          </div>
          <div style="max-height:400px;overflow-y:auto;">
            <div id="historyContent" class="loading">
              <div class="spinner"></div> Loading history...
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('historyModal').style.display='none'">Close</button>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('historyModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load history data
    loadUserHistory();
  }

  async function loadUserHistory() {
    try {
      const historyContent = document.getElementById('historyContent');
      const snap = await db.collection("tree_logs")
        .where("caretakerId", "==", currentUser.uid)
        .orderBy("timestamp", "desc")
        .limit(20)
        .get();
      
      if (snap.empty) {
        historyContent.innerHTML = '<div class="empty-state">No history found</div>';
        return;
      }
      
      let html = '<div class="observations-list">';
      snap.forEach(doc => {
        const log = doc.data();
        
        // Format the date using our helper function
        const dateStr = formatDate(log.timestamp);
        
        html += `
          <div class="observation-item">
            <div class="observation-header">
              <div class="observation-title">Tree Update</div>
              <span class="severity-badge ${log.newStatus === 'healthy' ? 'low' : log.newStatus === 'fair' ? 'medium' : 'high'}">${log.newStatus || 'unknown'}</span>
            </div>
            <div class="observation-meta">
              Tree ID: ${log.treeId} ‚Ä¢ ${dateStr}
            </div>
            <div class="observation-details">
              Changed from <strong>${log.oldStatus}</strong> to <strong>${log.newStatus}</strong>
              ${log.notes ? `<br>Notes: ${log.notes}` : ''}
            </div>
          </div>
        `;
      });
      html += '</div>';
      historyContent.innerHTML = html;
    } catch (err) {
      console.error(err);
      document.getElementById('historyContent').innerHTML = `<div class="loading" style="color:red;">Error loading history</div>`;
    }
  }

  // Logout
  function logout() {
    auth.signOut().then(() => {
      window.location.href = "index.html";
    }).catch(err => {
      alert("Logout error: " + err.message);
    });
  }

  // Auth init
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    currentUser = user;
    setTodayLabel();

    try {
      const doc = await db.collection("users").doc(user.uid).get();
      userDoc = doc.data() || {};
      userCollege = userDoc.collegeId;

      const initials = (userDoc.displayName || userDoc.name || user.email || "CT")
        .split(" ")
        .map(p => p[0])
        .join("")
        .toUpperCase()
        .slice(0, 2);
      document.getElementById("caretakerAvatar").textContent = initials;

      caretakerZoneId = userDoc.zoneId;

      if (!caretakerZoneId) {
        document.getElementById("caretakerZoneLabel").textContent = "No zone assigned";
        document.getElementById("treesGrid").innerHTML = '<div class="loading" style="color:orange;">No zone assigned to this caretaker.</div>';
        return;
      }

      // Get zone name
      try {
        const zoneDoc = await db.collection("zones").doc(caretakerZoneId).get();
        const zoneName = zoneDoc.exists ? zoneDoc.data().name : caretakerZoneId;

        document.getElementById("caretakerZoneLabel").textContent = `Caretaker ‚Ä¢ ${zoneName}`;
        document.getElementById("zoneDisplayName").textContent = zoneName;
      } catch (zoneErr) {
        console.error("Error loading zone:", zoneErr);
        document.getElementById("caretakerZoneLabel").textContent = `Caretaker ‚Ä¢ Zone: ${caretakerZoneId.substring(0, 8)}`;
        document.getElementById("zoneDisplayName").textContent = "Zone " + caretakerZoneId.substring(0, 8);
      }

      await loadZoneTrees();
      await loadObservations();
      await loadNotifications();

    } catch (err) {
      console.error(err);
      alert("Error loading dashboard: " + err.message);
    }
  });

  // Global functions - FIXED: Update tab function calls to pass event
  // Tab switching - FIXED: Remove event parameter and simplify
function switchTab(tabName) {
    // Prevent recursive calls
    const activeTab = document.querySelector('.tab-btn.active');
    if (activeTab && activeTab.textContent.includes(tabName)) {
        return; // Already on this tab
    }

    // Deactivate all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    // Activate selected tab
    const tabContent = document.getElementById(tabName + '-tab');
    const tabButton = Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
        btn.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1)) ||
        btn.onclick.toString().includes(tabName)
    );
    
    if (tabContent) tabContent.classList.add('active');
    if (tabButton) tabButton.classList.add('active');

    // Load appropriate data
    if (tabName === 'observations') {
        renderObservations();
    } else {
        renderTrees();
    }
}

// Update HTML onclick handlers to use simple call
// In your HTML, change from:
// onclick="switchTab('trees')" 
// to:
// onclick="switchTabSimple('trees')"

// Add a simpler version for HTML onclick
function switchTabSimple(tabName) {
    switchTab(tabName);
}

// Fix the global functions at the bottom
window.switchTab = switchTab;
window.switchTabSimple = switchTabSimple;

// Remove or fix the problematic switchTab wrapper
// DELETE THIS BLOCK from your original code:
/*
window.switchTab = (tabName) => {
    const event = { target: document.querySelector(`[onclick*="${tabName}"]`) };
    switchTab(tabName, event);
};
*/
  window.renderTrees = renderTrees;
  window.renderObservations = renderObservations;
  window.openHealthModal = openHealthModal;
  window.closeHealthModal = closeHealthModal;
  window.saveTreeHealth = saveTreeHealth;
  window.openQRModal = openQRModal;
  window.closeQRModal = closeQRModal;
  window.handleQRInput = handleQRInput;
  window.viewTreeDetails = viewTreeDetails;
  window.openObsResponseModal = openObsResponseModal;
  window.closeObsResponseModal = closeObsResponseModal;
  window.submitObsResponse = submitObsResponse;
  window.openNotificationsModal = () => {
    const event = { target: document.querySelector('.tab-btn:nth-child(2)') };
    switchTab('observations', event);
  };
  window.markNotificationRead = markNotificationRead;
  window.viewMyHistory = viewMyHistory;
  window.logout = logout;
</script>

</body>
</html>
